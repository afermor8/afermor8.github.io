<!DOCTYPE html>
<html lang="es" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Vpn. Redes Privadas Virtuales - Mi paso por ASIR Blog</title>
  <meta name="description" content="VPN. Redes Privadas Virtuales A) VPN de acceso remoto con OpenVPN y certificados x509 (5 puntos) Configura una conexión VPN de acceso remoto entre dos equipos del cloud:
Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes. Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.">
  <meta name="author" content="afermor8"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Mi paso por ASIR Blog",
    
    "url": "https:\/\/afermor8.github.io"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/afermor8.github.io"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/afermor8.github.io",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/afermor8.github.io\/post\/vpn\/",
          "name": "Vpn. redes privadas virtuales"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "afermor8"
  },
  "headline": "Vpn. Redes Privadas Virtuales",
  "description" : "VPN. Redes Privadas Virtuales A) VPN de acceso remoto con OpenVPN y certificados x509 (5 puntos) Configura una conexión VPN de acceso remoto entre dos equipos del cloud:\nUno de los dos equipos (el que actuará como servidor) estará conectado a dos redes. Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio \/etc\/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.",
  "inLanguage" : "es",
  "wordCount":  3433 ,
  "datePublished" : "2023-01-24T18:15:29",
  "dateModified" : "2023-01-24T18:15:29",
  "image" : "https:\/\/afermor8.github.io\/img\/avatar-icon.png",
  "keywords" : [ "SAD" ],
  "mainEntityOfPage" : "https:\/\/afermor8.github.io\/post\/vpn\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/afermor8.github.io",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/afermor8.github.io\/img\/avatar-icon.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Vpn. Redes Privadas Virtuales" />
<meta property="og:description" content="VPN. Redes Privadas Virtuales A) VPN de acceso remoto con OpenVPN y certificados x509 (5 puntos) Configura una conexión VPN de acceso remoto entre dos equipos del cloud:
Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes. Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.">
<meta property="og:image" content="https://afermor8.github.io/img/avatar-icon.png" />
<meta property="og:url" content="https://afermor8.github.io/post/vpn/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Mi paso por ASIR Blog" />

  <meta name="twitter:title" content="Vpn. Redes Privadas Virtuales" />
  <meta name="twitter:description" content="VPN. Redes Privadas Virtuales A) VPN de acceso remoto con OpenVPN y certificados x509 (5 puntos) Configura una conexión VPN de acceso remoto entre dos equipos del cloud:
Uno de los dos equipos (el que …">
  <meta name="twitter:image" content="https://afermor8.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://afermor8.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.104.3" />
  <link rel="alternate" href="https://afermor8.github.io/index.xml" type="application/rss+xml" title="Mi paso por ASIR Blog"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://afermor8.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://afermor8.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://afermor8.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Conmuta navegación</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://afermor8.github.io">Mi paso por ASIR Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Mi paso por ASIR Blog" href="https://afermor8.github.io">
            <img class="avatar-img" src="https://afermor8.github.io/img/avatar-icon.png" alt="Mi paso por ASIR Blog" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  
    <div id="header-big-imgs" data-num-img=3 
      
         
          data-img-src-1="/img/triangle.jpg" 
         
         data-img-desc-1="Triangle"
      
         
          data-img-src-2="/img/sphere.jpg" 
         
         data-img-desc-2="Sphere"
      
         
          data-img-src-3="/img/hexagon.jpg" 
         
         data-img-desc-3="Hexagon"
      ></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
                <h1>Vpn. Redes Privadas Virtuales</h1>
                  
                  
                    <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Publicado el January 24, 2023
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;17&nbsp;minutos
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3433&nbsp;palabras
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;afermor8
    
  
  
</span>


                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Vpn. Redes Privadas Virtuales</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Publicado el January 24, 2023
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;17&nbsp;minutos
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3433&nbsp;palabras
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;afermor8
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <hr>
<h2 id="vpn-redes-privadas-virtuales">VPN. Redes Privadas Virtuales</h2>
<hr>
<h3 id="a-vpn-de-acceso-remoto-con-openvpn-y-certificados-x509-5-puntos">A) VPN de acceso remoto con OpenVPN y certificados x509 (5 puntos)</h3>
<p>Configura una conexión VPN de acceso remoto entre dos equipos del cloud:</p>
<ul>
<li>Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes.</li>
<li>Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con  los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.</li>
<li>Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN. La dirección 10.99.99.1 se asignará al servidor VPN.</li>
<li>Los ficheros de configuración del servidor y del cliente se crearán en el directorio /etc/openvpn de cada máquina, y se llamarán servidor.conf y cliente.conf respectivamente.</li>
<li>Tras el establecimiento de la VPN, la máquina cliente debe ser capaz de acceder a una máquina que esté en la otra red a la que está conectado el servidor.</li>
</ul>
<p>Documenta el proceso detalladamente.</p>
<hr>
<p>Para empezar he creado el escenario con vagrant. He creado tres máquinas: servidorvpn (192.168.0.3 y 192.168.22.2), cliente1 (192.168.0.2) y aislada (192.168.22.3). Cada uno tendrá una configuración que pasaré a comentar a continuación. El Vagrantfile es el siguiente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">config.vm.synced_folder <span class="s2">&#34;.&#34;</span>, <span class="s2">&#34;/vagrant&#34;</span>, disabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.provider :libvirt <span class="k">do</span> <span class="p">|</span>libvirt<span class="p">|</span>
</span></span><span class="line"><span class="cl">    libvirt.cpus <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    libvirt.memory <span class="o">=</span> <span class="m">512</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :cliente1 <span class="k">do</span> <span class="p">|</span>cliente1<span class="p">|</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.hostname <span class="o">=</span> <span class="s2">&#34;cliente1&#34;</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;externa&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.0.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :servidorvpn <span class="k">do</span> <span class="p">|</span>servidorvpn<span class="p">|</span>
</span></span><span class="line"><span class="cl">    servidorvpn.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    servidorvpn.vm.hostname <span class="o">=</span> <span class="s2">&#34;servidorvpn&#34;</span>
</span></span><span class="line"><span class="cl">    servidorvpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;externa&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.0.3&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">    servidorvpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;interna&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.22.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :aislada <span class="k">do</span> <span class="p">|</span>aislada<span class="p">|</span>
</span></span><span class="line"><span class="cl">    aislada.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    aislada.vm.hostname <span class="o">=</span> <span class="s2">&#34;aislada&#34;</span>
</span></span><span class="line"><span class="cl">    aislada.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;interna&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.22.3&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">end
</span></span></code></pre></div><p><strong>En <em>servidorvpn</em>:</strong></p>
<p>Instalamos openvpn y activamos el bit de forwarding.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install openvpn
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo nano /etc/sysctl.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span></code></pre></div><p>Ejecutar <code>sudo sysctl -p</code> para que se active el bit de forwarding.</p>
<p>Vamos a crear el certificado y las claves con Openssl mediante easy-rsa. Para ello vamos a trabajar en el directorio /etc/openvpn. Copiamos aquí easy-rsa.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp -r /usr/share/easy-rsa /etc/openvpn
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/openvpn/easy-rsa
</span></span></code></pre></div><p>Activamos la infraestructura con init-pki:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ./easyrsa init-pki
</span></span></code></pre></div><p>Creamos el certificado de la <strong>CA</strong> y la clave privada.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ./easyrsa build-ca
</span></span></code></pre></div><p><img src="/img/vpn/2.png" alt="instancias"></p>
<p>El certificado generado <strong>ca.crt</strong> y la clave privada <strong>ca.key</strong> se encuentran en /etc/openvpn/easy-rsa/pki/ y pki/private/</p>
<p>Ahora creamos el certificado y la clave privada del <strong>servidor VPN</strong>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ./easyrsa build-server-full server nopass
</span></span></code></pre></div><p><img src="/img/vpn/3.png" alt="instancias"></p>
<p>El certificado es <strong>server.crt</strong> y la clave privada <strong>server.key</strong> (en pki/issued/ y pki/private/).</p>
<p>Creamos los parámetros <strong>Diffie-Helman</strong> para que haya un intercambio seguro entre los nodos (esto tarda un poco en generarse).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ./easyrsa gen-dh
</span></span></code></pre></div><p>Los parámetros <strong>dh.pem</strong> se crean en el directorio pki/.</p>
<p>A continuación genero el certificado y la clave privada del <strong>cliente</strong> (seguimos en la máquina servidorvpn), los cuales enviaremos mediante scp a la máquina cliente1.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ./easyrsa build-client-full clientevpn nopass
</span></span></code></pre></div><p><img src="/img/vpn/4.png" alt="instancias"></p>
<p>El certificado generado firmado por la clave privada de la CA se llama <strong>clientevpn.crt</strong> y la clave sería <strong>clientevpn.key</strong>.</p>
<p>Los enviamos a cliente1 junto con el certificado de la CA.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp -rp /etc/openvpn/easy-rsa/pki/<span class="o">{</span>ca.crt,issued/clientevpn.crt,private/clientevpn.key<span class="o">}</span> /home/vagrant/
</span></span><span class="line"><span class="cl"><span class="nb">cd</span>
</span></span><span class="line"><span class="cl">sudo chown vagrant:vagrant <span class="o">{</span>ca.crt,clientevpn.crt,clientevpn.key<span class="o">}</span>
</span></span><span class="line"><span class="cl">scp <span class="o">{</span>ca.crt,clientevpn.crt,clientevpn.key<span class="o">}</span> vagrant@192.168.0.2:.
</span></span></code></pre></div><p><img src="/img/vpn/5.png" alt="instancias"></p>
<p>Creo la configuración del tunel para el servidorvpn. Para ello primero copiamos la configuración por defecto de Openvpn y la modificamos según necesitemos.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/server/servidor.conf
</span></span><span class="line"><span class="cl">sudo nano /etc/openvpn/server/servidor.conf
</span></span></code></pre></div><p>En <strong>server</strong> he puesto el rango de ip virtuales. La máquina servidor-vpn cogerá por defecto la primera, es decir 10.99.99.1. El documento de configuración quedaría de la siguiente forma:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">port <span class="m">1194</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>proto tcp
</span></span><span class="line"><span class="cl">proto udp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>dev tap
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>dev-node MyTap
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ca /etc/openvpn/easy-rsa/pki/ca.crt
</span></span><span class="line"><span class="cl">cert /etc/openvpn/easy-rsa/pki/issued/server.crt
</span></span><span class="line"><span class="cl">key /etc/openvpn/easy-rsa/pki/private/server.key  <span class="c1"># This file should be kept secret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">dh /etc/openvpn/easy-rsa/pki/dh.pem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">topology subnet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server 10.99.99.0 255.255.255.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ifconfig-pool-persist /var/log/openvpn/ipp.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>server-bridge
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">push <span class="s2">&#34;route 192.168.22.0 255.255.255.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>push <span class="s2">&#34;route 192.168.20.0 255.255.255.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>client-config-dir ccd
</span></span><span class="line"><span class="cl"><span class="p">;</span>route 192.168.40.128 255.255.255.248
</span></span><span class="line"><span class="cl"><span class="p">;</span>client-config-dir ccd
</span></span><span class="line"><span class="cl"><span class="p">;</span>route 10.9.0.0 255.255.255.252
</span></span><span class="line"><span class="cl"><span class="p">;</span>learn-address ./script
</span></span><span class="line"><span class="cl"><span class="p">;</span>push <span class="s2">&#34;redirect-gateway def1 bypass-dhcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>push <span class="s2">&#34;dhcp-option DNS 208.67.222.222&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>push <span class="s2">&#34;dhcp-option DNS 208.67.220.220&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>client-to-client
</span></span><span class="line"><span class="cl"><span class="p">;</span>duplicate-cn
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">keepalive <span class="m">10</span> <span class="m">120</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#tls-auth ta.key 0 # This file is secret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>compress lz4-v2
</span></span><span class="line"><span class="cl"><span class="p">;</span>push <span class="s2">&#34;compress lz4-v2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>comp-lzo
</span></span><span class="line"><span class="cl"><span class="p">;</span>max-clients <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>user nobody
</span></span><span class="line"><span class="cl"><span class="p">;</span>group nogroup
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">status /var/log/openvpn/openvpn-status.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>log         /var/log/openvpn/openvpn.log
</span></span><span class="line"><span class="cl"><span class="p">;</span>log-append  /var/log/openvpn/openvpn.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>mute <span class="m">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">explicit-exit-notify <span class="m">1</span>
</span></span></code></pre></div><p>Iniciamos el servicio openvpn y comprobamos su funcionamiento:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now openvpn-server@servidor
</span></span><span class="line"><span class="cl">sudo systemctl status openvpn-server@servidor
</span></span></code></pre></div><p><img src="/img/vpn/7.png" alt="instancias"></p>
<p><strong>En <em>cliente1</em>:</strong></p>
<p>Instalamos openvpn y, a continuación, movemos los ficheros que recibimos anteriormente del servidor-vpn al directorio /etc/openvpn/client. Cambiamos el usuario de todos los ficheros a root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install openvpn
</span></span><span class="line"><span class="cl">sudo mv <span class="o">{</span>ca.crt,clientevpn.crt,clientevpn.key<span class="o">}</span> /etc/openvpn/client
</span></span><span class="line"><span class="cl">sudo chown root: /etc/openvpn/client/*
</span></span></code></pre></div><p>Creamos la configuración de openvpn para nuestro cliente.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/client/cliente.conf
</span></span><span class="line"><span class="cl">sudo nano /etc/openvpn/client/cliente.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">client
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>dev tap
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>dev-node MyTap
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>proto tcp
</span></span><span class="line"><span class="cl">proto udp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">remote 192.168.0.3 <span class="m">1194</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>remote my-server-2 <span class="m">1194</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>remote-random
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">resolv-retry infinite
</span></span><span class="line"><span class="cl">nobind
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>user nobody
</span></span><span class="line"><span class="cl"><span class="p">;</span>group nogroup
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>http-proxy-retry <span class="c1"># retry on connection failures</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>http-proxy <span class="o">[</span>proxy server<span class="o">]</span> <span class="o">[</span>proxy port <span class="c1">#]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>mute-replay-warnings
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ca /etc/openvpn/client/ca.crt
</span></span><span class="line"><span class="cl">cert /etc/openvpn/client/clientevpn.crt
</span></span><span class="line"><span class="cl">key /etc/openvpn/client/clientevpn.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">remote-cert-tls server
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#tls-auth ta.key 1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span>mute <span class="m">20</span>
</span></span></code></pre></div><p>Iniciamos el servicio openvpn y comprobamos su estado.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now openvpn-client@cliente
</span></span><span class="line"><span class="cl">sudo systemctl status openvpn-client@cliente
</span></span></code></pre></div><p><img src="/img/vpn/8.png" alt="cliente"></p>
<p><strong>En <em>aislada</em>:</strong></p>
<p>Cambiar la ruta por defecto:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ip route del default
</span></span><span class="line"><span class="cl">sudo ip route add default via 192.168.22.2
</span></span></code></pre></div><p><strong>Comprobaciones:</strong></p>
<p>Hacemos ping desde la máquina cliente1 al otro extremo de servidor-vpn (192.168.22.2). Y hacemos traceroute desde la máquina cliente1 al otro extremo de servidor-vpn (192.168.22.2).</p>
<p><img src="/img/vpn/prueba.png" alt="prueba"></p>
<p>Hacemos ping y traceroute al otro extremo del tunel (10.99.99.1).</p>
<p><img src="/img/vpn/prueba2.png" alt="prueba"></p>
<p>Hacemos ping y traceroute desde la máquina cliente1 a la máquina <strong>aislada</strong> (192.168.22.3).</p>
<p><img src="/img/vpn/prueba3.png" alt="prueba"></p>
<hr>
<h3 id="b-vpn-sitio-a-sitio-con-openvpn-y-certificados-x509-10-puntos">B) VPN sitio a sitio con OpenVPN y certificados x509 (10 puntos)</h3>
<p>Configura una conexión VPN sitio a sitio entre dos equipos del cloud:</p>
<ul>
<li>Cada equipo estará conectado a dos redes, una de ellas en común.</li>
<li>Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.</li>
<li>Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN.</li>
<li>Tras el establecimiento de la VPN, una máquina de cada red detrás de cada servidor VPN debe ser capaz de acceder a una máquina del otro extremo.
Documenta el proceso detalladamente.</li>
</ul>
<hr>
<p>Primero voy a crear el escenario. Borro las máquinas anteriores con vagrant destroy y modifico el Vagrantfile, quedando de la siguiente forma:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">config.vm.synced_folder <span class="s2">&#34;.&#34;</span>, <span class="s2">&#34;/vagrant&#34;</span>, disabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.provider :libvirt <span class="k">do</span> <span class="p">|</span>libvirt<span class="p">|</span>
</span></span><span class="line"><span class="cl">    libvirt.cpus <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    libvirt.memory <span class="o">=</span> <span class="m">512</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :cliente1 <span class="k">do</span> <span class="p">|</span>cliente1<span class="p">|</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.hostname <span class="o">=</span> <span class="s2">&#34;cliente1&#34;</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;privada1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.0.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :clientevpn <span class="k">do</span> <span class="p">|</span>clientevpn<span class="p">|</span>
</span></span><span class="line"><span class="cl">    clientevpn.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    clientevpn.vm.hostname <span class="o">=</span> <span class="s2">&#34;clientevpn&#34;</span>
</span></span><span class="line"><span class="cl">    clientevpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;privada1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.0.1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">    clientevpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;externa&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.10.1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :servervpn <span class="k">do</span> <span class="p">|</span>servervpn<span class="p">|</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.hostname <span class="o">=</span> <span class="s2">&#34;servervpn&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;externa&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.10.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;privada2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.20.1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :cliente2 <span class="k">do</span> <span class="p">|</span>cliente2<span class="p">|</span>
</span></span><span class="line"><span class="cl">    cliente2.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    cliente2.vm.hostname <span class="o">=</span> <span class="s2">&#34;cliente2&#34;</span>
</span></span><span class="line"><span class="cl">    cliente2.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;privada2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.20.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">end
</span></span></code></pre></div><p>Hago <code>vagrant up</code> y ya tendré mi nuevo escenario montado.</p>
<p><strong>En <em>servervpn</em>:</strong></p>
<p>Los primeros pasos serán iguales que en el anterior caso, por lo que no los explicaré:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install openvpn
</span></span><span class="line"><span class="cl">sudo nano /etc/sysctl.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo sysctl -p
</span></span><span class="line"><span class="cl">sudo cp -r /usr/share/easy-rsa /etc/openvpn
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/openvpn/easy-rsa
</span></span><span class="line"><span class="cl">sudo ./easyrsa init-pki
</span></span><span class="line"><span class="cl">sudo ./easyrsa build-ca
</span></span><span class="line"><span class="cl">sudo ./easyrsa build-server-full server nopass
</span></span><span class="line"><span class="cl">sudo ./easyrsa gen-dh
</span></span><span class="line"><span class="cl">sudo ./easyrsa build-client-full clientevpn nopass
</span></span><span class="line"><span class="cl"><span class="nb">cd</span>
</span></span><span class="line"><span class="cl">sudo cp -rp /etc/openvpn/easy-rsa/pki/<span class="o">{</span>ca.crt,issued/clientevpn.crt,private/clientevpn.key<span class="o">}</span> .
</span></span><span class="line"><span class="cl">sudo chown vagrant:vagrant <span class="o">{</span>ca.crt,clientevpn.crt,clientevpn.key<span class="o">}</span>
</span></span><span class="line"><span class="cl">scp <span class="o">{</span>ca.crt,clientevpn.crt,clientevpn.key<span class="o">}</span> vagrant@192.168.10.1:.
</span></span></code></pre></div><p>A partir de ahora empiezan las diferencias con respecto al caso anterior.</p>
<p>Creo el directorio ccd (client-config-dir), el cual contendrá un fichero llamado <strong>clientevpn</strong> que contendrá la otra red a la que se conecta clientevpn.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /etc/openvpn
</span></span><span class="line"><span class="cl">sudo mkdir ccd
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ccd
</span></span><span class="line"><span class="cl">sudo nano clientevpn
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iroute 192.168.0.0 255.255.255.0
</span></span></code></pre></div><p>Como en el apartado anterior voy a copiar el fichero de configuración de ejemplo de openvpn.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/server/servidor.conf
</span></span></code></pre></div><p>Modifico el fichero anterior según mis necesidades. Quedaría de la siguiente forma:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo nano /etc/openvpn/server/servidor.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">port <span class="m">1194</span>
</span></span><span class="line"><span class="cl">proto udp
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ca /etc/openvpn/easy-rsa/pki/ca.crt
</span></span><span class="line"><span class="cl">cert /etc/openvpn/easy-rsa/pki/issued/server.crt
</span></span><span class="line"><span class="cl">key /etc/openvpn/easy-rsa/pki/private/server.key
</span></span><span class="line"><span class="cl">dh /etc/openvpn/easy-rsa/pki/dh.pem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">topology subnet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server 10.99.99.0 255.255.255.0
</span></span><span class="line"><span class="cl">ifconfig-pool-persist /var/log/openvpn/ipp.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">push <span class="s2">&#34;route 192.168.20.0 255.255.255.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">client-config-dir /etc/openvpn/ccd
</span></span><span class="line"><span class="cl">route 192.168.0.0 255.255.255.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">keepalive <span class="m">10</span> <span class="m">120</span>
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl">status /var/log/openvpn/openvpn-status.log
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span><span class="line"><span class="cl">explicit-exit-notify <span class="m">1</span>
</span></span></code></pre></div><p>Iniciamos el servidor y comprobamos que funcione.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now openvpn-server@servidor
</span></span><span class="line"><span class="cl">sudo systemctl status openvpn-server@servidor
</span></span></code></pre></div><p><img src="/img/vpn/9.png" alt="prueba"></p>
<p><strong>En <em>clientevpn</em>:</strong></p>
<p>Actualizamos e instalamos openvpn.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install openvpn
</span></span></code></pre></div><p>Activamos el bit de forwarding.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo nano /etc/sysctl.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo sysctl -p
</span></span></code></pre></div><p>Movemos a /etc/openvpn/client los ficheros que habíamos pasado anteriormente desde el servidor.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo mv <span class="o">{</span>ca.crt,clientevpn.crt,clientevpn.key<span class="o">}</span> /etc/openvpn/client
</span></span><span class="line"><span class="cl">sudo chown root:root /etc/openvpn/client/*
</span></span></code></pre></div><p>Y creamos el fichero de configuración para el cliente VPN.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/client/cliente.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo nano /etc/openvpn/client/cliente.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">client
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl">proto udp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">remote 192.168.10.2 <span class="m">1194</span>
</span></span><span class="line"><span class="cl">resolv-retry infinite
</span></span><span class="line"><span class="cl">nobind
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ca /etc/openvpn/client/ca.crt
</span></span><span class="line"><span class="cl">cert /etc/openvpn/client/clientevpn.crt
</span></span><span class="line"><span class="cl">key /etc/openvpn/client/clientevpn.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">remote-cert-tls server
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span></code></pre></div><p>Habilitamos el servicio y comprobamos que funciona correctamente.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now openvpn-client@cliente
</span></span><span class="line"><span class="cl">sudo systemctl status openvpn-client@cliente
</span></span></code></pre></div><p><img src="/img/vpn/10.png" alt="prueba"></p>
<p><strong>En <em>cliente1</em>:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ip route del default
</span></span><span class="line"><span class="cl">sudo ip route add default via 192.168.0.1
</span></span></code></pre></div><p><img src="/img/vpn/11.png" alt="prueba"></p>
<p><strong>En <em>cliente2</em>:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ip route del default
</span></span><span class="line"><span class="cl">sudo ip route add default via 192.168.20.1
</span></span></code></pre></div><p><img src="/img/vpn/12.png" alt="prueba"></p>
<p><strong>Comprobación:</strong></p>
<p>Hacemos ping y traceroute desde clientevpn al otro extremo del túnel (10.99.99.1).</p>
<p><img src="/img/vpn/prueba5.png" alt="prueba"></p>
<p>Hacemos ping y traceroute desde cliente1 a cliente2 (192.168.20.2).</p>
<p><img src="/img/vpn/prueba6.png" alt="prueba"></p>
<p>Hacemos ping y traceroute desde cliente2 a cliente1 (192.168.0.2).</p>
<p><img src="/img/vpn/prueba7.png" alt="prueba"></p>
<hr>
<h3 id="c-vpn-de-acceso-remoto-con-wireguard-5-puntos">C) VPN de acceso remoto con WireGuard (5 puntos)</h3>
<p>Monta una VPN de acceso remoto usando Wireguard. Intenta probarla con clientes Windows, Linux y Android. Documenta el proceso adecuadamente y compáralo con el del apartado A.</p>
<hr>
<h4 id="desde-cliente-debian-11">Desde cliente Debian 11</h4>
<p>Primero creo el escenario para hacerlo desde un cliente Debian 11, que será el siguiente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">config.vm.synced_folder <span class="s2">&#34;.&#34;</span>, <span class="s2">&#34;/vagrant&#34;</span>, disabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.provider :libvirt <span class="k">do</span> <span class="p">|</span>libvirt<span class="p">|</span>
</span></span><span class="line"><span class="cl">    libvirt.cpus <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    libvirt.memory <span class="o">=</span> <span class="m">512</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :clientelx <span class="k">do</span> <span class="p">|</span>clientelx<span class="p">|</span>
</span></span><span class="line"><span class="cl">    clientelx.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    clientelx.vm.hostname <span class="o">=</span> <span class="s2">&#34;clientelx&#34;</span>
</span></span><span class="line"><span class="cl">    clientelx.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;redexterna&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.50.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :servervpn <span class="k">do</span> <span class="p">|</span>servervpn<span class="p">|</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.hostname <span class="o">=</span> <span class="s2">&#34;servervpn&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;redexterna&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.50.1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;redinterna&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.80.1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :aislada <span class="k">do</span> <span class="p">|</span>aislada<span class="p">|</span>
</span></span><span class="line"><span class="cl">    aislada.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    aislada.vm.hostname <span class="o">=</span> <span class="s2">&#34;aislada&#34;</span>
</span></span><span class="line"><span class="cl">    aislada.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;redinterna&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.80.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">end
</span></span></code></pre></div><p><strong>En <em>servervpn</em>:</strong></p>
<p>Instalamos Wireguard.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install wireguard
</span></span></code></pre></div><p>En este caso no activaremos el bit de forwarding manualmente ya que lo haremos directamente desde el fichero de configuración de Wireguard.</p>
<p>Generamos el par de claves en <strong>/etc/wireguard/</strong>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo su
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/wireguard/
</span></span><span class="line"><span class="cl">wg genkey <span class="p">|</span> tee serverprivatekey <span class="p">|</span> wg pubkey &gt; serverpublickey
</span></span></code></pre></div><p>Creamos el fichero de configuración (en la opción &lsquo;PrivateKey&rsquo; debemos copiar la clave privada generada anteriormente).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat serverprivatekey
</span></span><span class="line"><span class="cl">nano wg0.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Server config</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Interface<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Address</span> <span class="o">=</span> 10.99.99.1
</span></span><span class="line"><span class="cl"><span class="nv">PrivateKey</span> <span class="o">=</span> yG48lnvU/+blnbVOSmIDz5yyDRsGAFmCqLSxQRous2Q<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">ListenPort</span> <span class="o">=</span> <span class="m">51820</span>
</span></span><span class="line"><span class="cl"><span class="c1"># IP forwarding</span>
</span></span><span class="line"><span class="cl"><span class="nv">PreUp</span> <span class="o">=</span> sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#iptables rules</span>
</span></span><span class="line"><span class="cl"><span class="nv">PostUp</span> <span class="o">=</span> iptables -A FORWARD -i %i -j ACCEPT<span class="p">;</span> iptables -A FORWARD -o %i -j ACCEPT<span class="p">;</span> iptables -t nat -A POSTROUTING -o wlp3s0 -j MASQUERADE
</span></span><span class="line"><span class="cl"><span class="nv">PostDown</span> <span class="o">=</span> iptables -D FORWARD -i %i -j ACCEPT<span class="p">;</span> iptables -D FORWARD -o %i -j ACCEPT<span class="p">;</span> iptables -t nat -D POSTROUTING -o wlp3s0 -j MASQUERADE
</span></span></code></pre></div><p>Modificamos los permisos por seguridad.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod <span class="m">600</span> /etc/wireguard/ -R
</span></span></code></pre></div><p>Avtivamos la interfaz creada y comprobamos que funciona.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">wg
</span></span><span class="line"><span class="cl">ip -br a
</span></span></code></pre></div><p><img src="/img/vpn/13.png" alt="prueba"></p>
<p><strong>En <em>clientelx</em>:</strong></p>
<p>Instalo Wireguard y creo el par de claves en /etc/wireguard.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install wireguard
</span></span><span class="line"><span class="cl">sudo su
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/wireguard
</span></span><span class="line"><span class="cl">wg genkey <span class="p">|</span> tee clientprivatekey <span class="p">|</span> wg pubkey &gt; clientpublickey
</span></span></code></pre></div><p>Creo el fichero de configuración.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat clientprivatekey
</span></span><span class="line"><span class="cl">cat clientpublickey 
</span></span><span class="line"><span class="cl">nano wg0.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Interface<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Address</span> <span class="o">=</span> 10.99.99.2
</span></span><span class="line"><span class="cl"><span class="nv">PrivateKey</span> <span class="o">=</span> 4HH9loDo2Bj90nYw4ZlKOGeWS0Bk9lLa/Aw/jSnuSFU<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">ListenPort</span> <span class="o">=</span> <span class="m">51820</span>
</span></span><span class="line"><span class="cl"><span class="nv">PostUp</span> <span class="o">=</span> ip route add 192.168.80.0/24 dev wg0
</span></span><span class="line"><span class="cl"><span class="nv">PostDown</span> <span class="o">=</span> ip route del 192.168.80.0/24 dev wg0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Peer<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">PublicKey</span> <span class="o">=</span> p/Fg6cK6MPh76HWi7B0dj44ISBJjb8D263a8b5cSQ18<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">AllowedIPs</span> <span class="o">=</span> 0.0.0.0/0
</span></span><span class="line"><span class="cl"><span class="nv">Endpoint</span> <span class="o">=</span> 192.168.50.1:51820
</span></span><span class="line"><span class="cl"><span class="nv">PersistentKeepalive</span> <span class="o">=</span> <span class="m">25</span>
</span></span></code></pre></div><p>En PrivateKey copio la clave privada del cliente con <code>cat clientprivatekey</code>.</p>
<p>En Postup y Postdown habrá que poner la red interna a la que nos conectaremos.</p>
<p>En Endpoint tendremos que poner la IP del servidor Wireguard (servervpn), el que configuramos en el punto anterior, y en PublicKey voy a copiar la <strong>clave pública</strong> de <strong>servervpn</strong> con <code>cat clientpublickey</code>.</p>
<p>Cambiamos los permisos.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod <span class="m">600</span> /etc/wireguard/ -R
</span></span></code></pre></div><p>Ahora activamos la interfaz y comprobamos que funciona.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">ip -br a
</span></span></code></pre></div><p><img src="/img/vpn/13.png" alt="prueba"></p>
<p>Por último, añadimos <strong>en servervpn</strong> el bloque Peer del cliente que acabamos de configurar. Añadimos al fichero de configuración <strong>wg0.conf</strong> lo siguiente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Cliente Debian 11</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Peer<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Publickey</span> <span class="o">=</span> <span class="nv">Xs2GEu0honQOS3clIjosaLUa7D0VwnrbSTIALr7cvk4</span><span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">AllowedIPs</span> <span class="o">=</span> 10.99.99.2/32
</span></span><span class="line"><span class="cl"><span class="nv">PersistentKeepAlive</span> <span class="o">=</span> <span class="m">25</span>
</span></span></code></pre></div><p>En Publickey hay que poner la clave pública del cliente.</p>
<p>Reiniciamos el servicio y comprobamos que funciona.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick down wg0
</span></span><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">wg
</span></span><span class="line"><span class="cl">ip r
</span></span></code></pre></div><p><img src="/img/vpn/15.png" alt="prueba"></p>
<p><strong>En <em>aislada</em>:</strong></p>
<p>Cambiamos la ruta por defecto en la máquina aislada.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ip r del default
</span></span><span class="line"><span class="cl">sudo ip r add default via 192.168.80.1
</span></span></code></pre></div><p><img src="/img/vpn/17.png" alt="prueba"></p>
<p><strong>Comprobación:</strong></p>
<p>Volvemos a la máquina <strong>clientelx</strong> y probamos que se puede hacer ping y traceroute a la máquina <strong>aislada</strong> de la red interna.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ping 192.168.80.2
</span></span><span class="line"><span class="cl">traceroute 192.168.80.2
</span></span></code></pre></div><p><img src="/img/vpn/18.png" alt="prueba"></p>
<p>Hacemos ping y traceroute desde <strong>clientelx</strong> al otro extremo del túnel.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ping 10.99.99.1
</span></span><span class="line"><span class="cl">traceroute 10.99.99.1
</span></span></code></pre></div><p><img src="/img/vpn/20.png" alt="prueba"></p>
<p>Hacemos ping y traceroute desde la máquina <strong>aislada</strong> de la red interna a la interfaz del túnel del cliente externo.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ping 10.99.99.2
</span></span><span class="line"><span class="cl">traceroute 10.99.99.2
</span></span></code></pre></div><p><img src="/img/vpn/19.png" alt="prueba"></p>
<h4 id="desde-windows-10">Desde <em>Windows 10</em></h4>
<p>Iniciamos la máquina y lo primero que haremos es instalar Wireguard desde la <a href="https://www.wireguard.com/install/">página oficial</a>.</p>
<p><img src="/img/vpn/24.png" alt="prueba"></p>
<p>Ahora conectamos la máquina Windows 10 a la red <strong>redexterna</strong> creada anteriormente.</p>
<p><img src="/img/vpn/21.png" alt="prueba"></p>
<p>En Símbolo del sistema (como administrador) configuramos la interfaz de forma estática.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">netsh interface ip <span class="nb">set</span> address <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;Ethernet&#34;</span> static 192.168.50.3 255.255.255.0 192.168.50.1
</span></span></code></pre></div><p>Compruebo la configuración y si tenemos conectividad.</p>
<p><img src="/img/vpn/22.png" alt="prueba">
<img src="/img/vpn/23.png" alt="prueba"></p>
<p>Iniciamos el programa y creamos un túnel vacío.</p>
<p><img src="/img/vpn/25.png" alt="prueba"></p>
<p>Se generan las claves de forma automática.</p>
<p><img src="/img/vpn/26.png" alt="prueba"></p>
<p>Completamos la configuración.</p>
<p><img src="/img/vpn/27.png" alt="prueba"></p>
<p>Ya nos aparecerá el tunel creado en el programa Wireguard.</p>
<p><img src="/img/vpn/28.png" alt="prueba"></p>
<p><strong>En <em>servervpn</em>:</strong></p>
<p>A continuación vamos a la máquina servervpn y añadimos al fichero wg0.conf lo siguiente.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#Cliente Windows 10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Peer<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">PublicKey</span> <span class="o">=</span> p9xaV3uyUxqq89E79sgdj52AGcapJ+D4GqMJn/ZI31g<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">AllowedIPs</span> <span class="o">=</span> 10.99.99.3/32
</span></span><span class="line"><span class="cl"><span class="nv">PersistentKeepAlive</span> <span class="o">=</span> <span class="m">25</span>
</span></span></code></pre></div><p>Reiniciamos wireguard.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick down wg0
</span></span><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">wg
</span></span></code></pre></div><p><img src="/img/vpn/29.png" alt="prueba"></p>
<p><strong>Volvemos al cliente Windows 10:</strong></p>
<p>Activamos el túnel que creamos anteriormente.</p>
<p><img src="/img/vpn/30.png" alt="prueba"></p>
<p><img src="/img/vpn/31.png" alt="prueba"></p>
<p>Comprobamos que se nos ha creado la interfaz del túnel.</p>
<p><img src="/img/vpn/32.png" alt="prueba"></p>
<p><strong>Comprobación:</strong></p>
<p>Hacemos ping y tracert desde Windows al otro extremo del túnel:</p>
<p><img src="/img/vpn/.png" alt="prueba"></p>
<p>Hacemos ping y tracert desde Windows a la máquina <strong>aislada</strong>.</p>
<p><img src="/img/vpn/.png" alt="prueba"></p>
<h4 id="desde-android">Desde <em>Android</em></h4>
<p>En este caso voy a utilizar mi teléfono móvil Android (192.168.1.130) conectado a mi máquina host (192.168.1.248) para crear un túnel y poderme conectar a una máquina llamada aislada (192.168.121.12) que está conectada a mi host (192.168.121.1).</p>
<p>Para hacer esto primero tendremos que configurar mi host con wireguard como hicimos en el primer caso.</p>
<p>Instalamos Wireguard y generamos el par de claves.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install wireguard
</span></span><span class="line"><span class="cl">sudo su
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/wireguard/
</span></span><span class="line"><span class="cl">wg genkey <span class="p">|</span> tee serverprivatekey <span class="p">|</span> wg pubkey &gt; serverpublickey
</span></span></code></pre></div><p>Creamos el fichero de configuración.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat serverprivatekey
</span></span><span class="line"><span class="cl">nano wg0.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Server config</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Interface<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Address</span> <span class="o">=</span> 10.99.99.1
</span></span><span class="line"><span class="cl"><span class="nv">PrivateKey</span> <span class="o">=</span> mPGSoAZLQZg/B4Dqy3htpv4sMJgUIiZBSYaNandPA0A<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">ListenPort</span> <span class="o">=</span> <span class="m">51820</span>
</span></span><span class="line"><span class="cl"><span class="c1"># IP forwarding</span>
</span></span><span class="line"><span class="cl"><span class="nv">PreUp</span> <span class="o">=</span> sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#iptables rules</span>
</span></span><span class="line"><span class="cl"><span class="nv">PostUp</span> <span class="o">=</span> iptables -A FORWARD -i %i -j ACCEPT<span class="p">;</span> iptables -A FORWARD -o %i -j ACCEPT<span class="p">;</span> iptables -t nat -A POSTROUTING -o wlp3s0 -j MASQUERADE
</span></span><span class="line"><span class="cl"><span class="nv">PostDown</span> <span class="o">=</span> iptables -D FORWARD -i %i -j ACCEPT<span class="p">;</span> iptables -D FORWARD -o %i -j ACCEPT<span class="p">;</span> iptables -t nat -D POSTROUTING -o wlp3s0 -j MASQUERADE
</span></span></code></pre></div><p>Modificamos los permisos.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod <span class="m">600</span> /etc/wireguard/ -R
</span></span></code></pre></div><p>Avtivamos la interfaz creada y comprobamos que funciona.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">wg
</span></span><span class="line"><span class="cl">ip -br a
</span></span></code></pre></div><p><img src="/img/vpn/35.png" alt="prueba"></p>
<p>Vamos ahora al teléfono Android y descargamos Wireguard.</p>
<p><img src="/img/vpn/movil1.jpeg" alt="prueba"></p>
<p>Para crear el túnel vamos a usar la opción de crear desde cero.</p>
<p><img src="/img/vpn/movil2.jpeg" alt="prueba"></p>
<p>Generamos el par de claves y completamos la configuración.</p>
<p><img src="/img/vpn/movil3.jpeg" alt="prueba"></p>
<p><img src="/img/vpn/movil4.jpeg" alt="prueba"></p>
<p><img src="/img/vpn/movil5.jpeg" alt="prueba"></p>
<p><img src="/img/vpn/movil6.jpeg" alt="prueba"></p>
<p>En la captura anterior me faltó poner el puerto, pero en la siguiente se ve correctamente creado.</p>
<p><img src="/img/vpn/movil7.jpeg" alt="prueba"></p>
<p>Vamos a nuestro host y modificamos el fichero de configuración wg0.conf. Añadimos lo siguiente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Cliente Android</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Peer<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">PublicKey</span> <span class="o">=</span> bwYcPk16D5PLJL1yf82J/BiaS0aVTIt+fVUgUNrPkkE<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">AllowedIPs</span> <span class="o">=</span> 10.99.99.2/32
</span></span></code></pre></div><p>Reiniciamos el servidor vpn.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick down wg0
</span></span><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">wg
</span></span></code></pre></div><p><img src="/img/vpn/36.png" alt="prueba"></p>
<p>Ahora sí vamos a nuestro teléfono y activamos el túnel creado.</p>
<p><img src="/img/vpn/movil8.jpeg" alt="prueba"></p>
<p>Con Terminal Emulator comprobamos que se ha creado el túnel.</p>
<p><strong>Comprobación:</strong></p>
<p>Hacemos ping y traceroute al otro extremo del túnel (10.99.99.1).</p>
<p><img src="/img/vpn/.png" alt="prueba"></p>
<p>Hacemos ping y traceroute a la máquina aislada (192.168.121.12).</p>
<p><img src="/img/vpn/.png" alt="prueba"></p>
<hr>
<h3 id="d-vpn-sitio-a-sitio-con-wireguard-10-puntos">D) VPN sitio a sitio con WireGuard (10 puntos)</h3>
<p>Configura una VPN sitio a sitio usando WireGuard. Documenta el proceso adecuadamente y compáralo con el del apartado B.</p>
<hr>
<p>Creo mi escenario.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">config.vm.synced_folder <span class="s2">&#34;.&#34;</span>, <span class="s2">&#34;/vagrant&#34;</span>, disabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.provider :libvirt <span class="k">do</span> <span class="p">|</span>libvirt<span class="p">|</span>
</span></span><span class="line"><span class="cl">    libvirt.cpus <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    libvirt.memory <span class="o">=</span> <span class="m">512</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :cliente1 <span class="k">do</span> <span class="p">|</span>cliente1<span class="p">|</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.hostname <span class="o">=</span> <span class="s2">&#34;cliente1&#34;</span>
</span></span><span class="line"><span class="cl">    cliente1.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;privada1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.0.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :clientevpn <span class="k">do</span> <span class="p">|</span>clientevpn<span class="p">|</span>
</span></span><span class="line"><span class="cl">    clientevpn.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    clientevpn.vm.hostname <span class="o">=</span> <span class="s2">&#34;clientevpn&#34;</span>
</span></span><span class="line"><span class="cl">    clientevpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;privada1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.0.1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">    clientevpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;externa&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.10.1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :servervpn <span class="k">do</span> <span class="p">|</span>servervpn<span class="p">|</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.hostname <span class="o">=</span> <span class="s2">&#34;servervpn&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;externa&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.10.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">    servervpn.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;privada2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.20.1&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  config.vm.define :cliente2 <span class="k">do</span> <span class="p">|</span>cliente2<span class="p">|</span>
</span></span><span class="line"><span class="cl">    cliente2.vm.box <span class="o">=</span> <span class="s2">&#34;debian/bullseye64&#34;</span>
</span></span><span class="line"><span class="cl">    cliente2.vm.hostname <span class="o">=</span> <span class="s2">&#34;cliente2&#34;</span>
</span></span><span class="line"><span class="cl">    cliente2.vm.network :private_network,
</span></span><span class="line"><span class="cl">      :libvirt__network_name <span class="o">=</span>&gt; <span class="s2">&#34;privada2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__dhcp_enabled <span class="o">=</span>&gt; false,
</span></span><span class="line"><span class="cl">      :ip <span class="o">=</span>&gt; <span class="s2">&#34;192.168.20.2&#34;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__netmask <span class="o">=</span>&gt; <span class="s1">&#39;255.255.255.0&#39;</span>,
</span></span><span class="line"><span class="cl">      :libvirt__forward_mode <span class="o">=</span>&gt; <span class="s2">&#34;veryisolated&#34;</span>
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">end
</span></span></code></pre></div><p><strong>En <em>servervpn</em>:</strong></p>
<p>Instalamos Wireguard y creamos el par de claves:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install wireguard
</span></span><span class="line"><span class="cl">sudo su
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/wireguard/
</span></span><span class="line"><span class="cl">wg genkey <span class="p">|</span> tee serverprivatekey <span class="p">|</span> wg pubkey &gt; serverpublickey
</span></span></code></pre></div><p>Creamos el fichero de configuración (en la opción &lsquo;PrivateKey&rsquo; debemos copiar la clave privada generada anteriormente).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat serverprivatekey
</span></span><span class="line"><span class="cl">nano wg0.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Server config</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Interface<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Address</span> <span class="o">=</span> 10.99.99.1
</span></span><span class="line"><span class="cl"><span class="nv">PrivateKey</span> <span class="o">=</span> sKwLpKSnuc2a99wQuWNIVC1zlXoawS/Q1we/enoAlFU<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">ListenPort</span> <span class="o">=</span> <span class="m">51820</span>
</span></span><span class="line"><span class="cl"><span class="c1"># IP forwarding</span>
</span></span><span class="line"><span class="cl"><span class="nv">PreUp</span> <span class="o">=</span> sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#iptables rules</span>
</span></span><span class="line"><span class="cl"><span class="nv">PostUp</span> <span class="o">=</span> iptables -A FORWARD -i %i -j ACCEPT<span class="p">;</span> iptables -A FORWARD -o %i -j ACCEPT<span class="p">;</span> iptables -t nat -A POSTROUTING -o wlp3s0 -j MASQUERADE
</span></span><span class="line"><span class="cl"><span class="nv">PostDown</span> <span class="o">=</span> iptables -D FORWARD -i %i -j ACCEPT<span class="p">;</span> iptables -D FORWARD -o %i -j ACCEPT<span class="p">;</span> iptables -t nat -D POSTROUTING -o wlp3s0 -j MASQUERADE
</span></span></code></pre></div><p>Modificamos los permisos por seguridad.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod <span class="m">600</span> /etc/wireguard/ -R
</span></span></code></pre></div><p>Avtivamos la interfaz creada y comprobamos que funciona.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">wg
</span></span><span class="line"><span class="cl">ip -br a
</span></span></code></pre></div><p><img src="/img/vpn/37.png" alt="prueba"></p>
<p><strong>En <em>clientevpn</em>:</strong></p>
<p>Instalamos Wireguard y creamos el par de claves:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install wireguard
</span></span><span class="line"><span class="cl">sudo su
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/wireguard/
</span></span><span class="line"><span class="cl">wg genkey <span class="p">|</span> tee serverprivatekey <span class="p">|</span> wg pubkey &gt; serverpublickey
</span></span></code></pre></div><p>Creamos el fichero de configuración (en la opción &lsquo;PrivateKey&rsquo; debemos copiar la clave privada generada anteriormente).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat serverprivatekey
</span></span><span class="line"><span class="cl">nano wg0.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Server config</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Interface<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Address</span> <span class="o">=</span> 10.99.99.2
</span></span><span class="line"><span class="cl"><span class="nv">PrivateKey</span> <span class="o">=</span> <span class="nv">mIbxPUe7OEmOPxLTiDV7NOPDBOFn8TwKn3ydrwU3OFA</span><span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">ListenPort</span> <span class="o">=</span> <span class="m">51820</span>
</span></span><span class="line"><span class="cl"><span class="c1"># IP forwarding</span>
</span></span><span class="line"><span class="cl"><span class="nv">PreUp</span> <span class="o">=</span> sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#iptables rules</span>
</span></span><span class="line"><span class="cl"><span class="nv">PostUp</span> <span class="o">=</span> iptables -A FORWARD -i %i -j ACCEPT<span class="p">;</span> iptables -A FORWARD -o %i -j ACCEPT<span class="p">;</span> iptables -t nat -A POSTROUTING -o wlp3s0 -j MASQUERADE
</span></span><span class="line"><span class="cl"><span class="nv">PostDown</span> <span class="o">=</span> iptables -D FORWARD -i %i -j ACCEPT<span class="p">;</span> iptables -D FORWARD -o %i -j ACCEPT<span class="p">;</span> iptables -t nat -D POSTROUTING -o wlp3s0 -j MASQUERADE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Peer<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Endpoint</span> <span class="o">=</span> 192.168.10.2:51820
</span></span><span class="line"><span class="cl"><span class="nv">AllowedIPs</span> <span class="o">=</span> 10.99.99.1/32, 192.168.20.0/24
</span></span><span class="line"><span class="cl"><span class="nv">PublicKey</span> <span class="o">=</span> kZ6g7uh5hT56zRQfnzxEzESYjiqXhH/sHKVGJIuahkU<span class="o">=</span>
</span></span></code></pre></div><p>Modificamos los permisos por seguridad.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod <span class="m">600</span> /etc/wireguard/ -R
</span></span></code></pre></div><p>Avtivamos la interfaz creada y comprobamos que funciona.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">wg
</span></span><span class="line"><span class="cl">ip -br a
</span></span></code></pre></div><p><img src="/img/vpn/38.png" alt="prueba"></p>
<p>Volvemos a <strong>servervpn</strong> y añadimos al fichero de configuración lo siguiente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>Peer<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Endpoint</span> <span class="o">=</span> 192.168.10.1:51820
</span></span><span class="line"><span class="cl"><span class="nv">AllowedIPs</span> <span class="o">=</span> 10.99.99.2/32, 192.168.0.0/24
</span></span><span class="line"><span class="cl"><span class="nv">PublicKey</span> <span class="o">=</span> SWxKNObvpaunCOUg+HNxgd9UHxBQEIl02Q5vZJIWI0Y<span class="o">=</span>
</span></span></code></pre></div><p>Reiniciamos.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wg-quick down wg0
</span></span><span class="line"><span class="cl">wg-quick up wg0
</span></span><span class="line"><span class="cl">wg
</span></span><span class="line"><span class="cl">ip -br a
</span></span></code></pre></div><p><img src="/img/vpn/39.png" alt="prueba"></p>
<p><strong>En <em>cliente1</em>:</strong></p>
<p>Cambiamos la ruta por defecto.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ip route del default
</span></span><span class="line"><span class="cl">sudo ip route add default via 192.168.0.1
</span></span></code></pre></div><p><img src="/img/vpn/40.png" alt="prueba"></p>
<p><strong>En <em>cliente2</em>:</strong></p>
<p>Cambiamos la ruta por defecto.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ip route del default
</span></span><span class="line"><span class="cl">sudo ip route add default via 192.168.20.1
</span></span></code></pre></div><p><img src="/img/vpn/41.png" alt="prueba"></p>
<p><strong>Comprobación:</strong></p>
<p>Hacemos ping y traceroute desde <strong>clientevpn</strong> al otro extremo del túnel:</p>
<p><img src="/img/vpn/42.png" alt="prueba"></p>
<p>Hacemos ping y traceroute desde <strong>cliente1</strong> a <strong>cliente2</strong>:</p>
<p><img src="/img/vpn/43.png" alt="prueba"></p>
<p>Hacemos ping y traceroute desde <strong>cliente2</strong> a <strong>cliente1</strong>:</p>
<p><img src="/img/vpn/44.png" alt="prueba"></p>
<hr>
<h3 id="extra-1-vpn-de-acceso-remoto-con-ipsec-5-puntos">Extra 1) VPN de acceso remoto con Ipsec (5 puntos)</h3>
<p>Elige una aplicación por software (por ejemplo, FreeS/Wan) y monta la configuración. Documenta el proceso detalladamente.</p>
<hr>
<h3 id="extra-2-vpn-sitio-a-sitio-con-ipsec-10-puntos">Extra 2) VPN sitio a sitio con IPsec (10 puntos)</h3>
<p>Montando el escenario en GNS3 usando routers CISCO o con una aplicación por software (por ejemplo, FreeS/Wan) despliega la configuración solicitada. Documenta el proceso detalladamente.</p>


        
          <div class="blog-tags">
            
              <a href="https://afermor8.github.io/tags/sad/">SAD</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fafermor8.github.io%2fpost%2fvpn%2f&amp;text=Vpn.%20Redes%20Privadas%20Virtuales&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fafermor8.github.io%2fpost%2fvpn%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fafermor8.github.io%2fpost%2fvpn%2f&amp;title=Vpn.%20Redes%20Privadas%20Virtuales" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fafermor8.github.io%2fpost%2fvpn%2f&amp;title=Vpn.%20Redes%20Privadas%20Virtuales" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fafermor8.github.io%2fpost%2fvpn%2f&amp;title=Vpn.%20Redes%20Privadas%20Virtuales" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fafermor8.github.io%2fpost%2fvpn%2f&amp;description=Vpn.%20Redes%20Privadas%20Virtuales" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">Ver también</h4>
                  <ul>
                
                
                    <li><a href="/post/firewall2/">Cortafuegos II: Perimetral con nftables</a></li>
                
                    <li><a href="/post/firewall1/">Cortafuegos I: de nodo con iptables</a></li>
                
                    <li><a href="/post/forense/">Informática Forense</a></li>
                
                    <li><a href="/post/cripto3/">Criptografía III. Certificados digiales. HTTPS</a></li>
                
                    <li><a href="/post/cripto2/">Criptografía II. Integridad, firmas y autenticación</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://afermor8.github.io/post/cripto3/" data-toggle="tooltip" data-placement="top" title="Criptografía III. Certificados digiales. HTTPS">&larr; Artículo anterior</a>
            </li>
          
          
            <li class="next">
              <a href="https://afermor8.github.io/post/django/" data-toggle="tooltip" data-placement="top" title="Despliegue de aplicaciones Python (Django)">Artículo siguiente &rarr;</a>
            </li>
          
        </ul>
      


      
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="mailto:ara.fer.mor@gmail.com" title="Email me">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://github.com/afermor8" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://Afermor.slack.com/" title="Slack">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-slack fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://linkedin.com/in/arantxa-f-6136617b" title="LinkedIn">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://telegram.me/arantxipu" title="Telegram">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-telegram fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="afermor8.github.io">afermor8</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2023
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://afermor8.github.io">Mi paso por ASIR Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.104.3</a> alimentada &nbsp;&bull;&nbsp; Tema <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adaptado de <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://afermor8.github.io/js/main.js"></script>
<script src="https://afermor8.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://afermor8.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

